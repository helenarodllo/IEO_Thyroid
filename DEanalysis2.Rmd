---
output:
  bookdown::gitbook: default
  bookdown::pdf_book: default
---

```{r setup, cache=FALSE, echo=FALSE, results='hide', message=FALSE}
library(knitr)
library(SummarizedExperiment)
library(edgeR)
library(geneplotter)
library(sva)
library(corpcor)

opts_chunk$set(cache=TRUE,
               cache.path="cache/file2",
               cache.extra=R.version.string,
               autodep=TRUE,
               fig.align="center",
               comment="")

thca <- readRDS(file.path("raw_counts", "seTHCA.rds"))
dge <- readRDS(file.path("results", "dge.rds"))
thca.filt.unnorm <- readRDS(file.path("results", "thca.filt.unnorm.rds"))
dge.filt.unnorm <- readRDS(file.path("results", "dge.filt.unnorm.rds"))
thca.filt <- readRDS(file.path("results", "thca.filt4.rds"))
dge.filt <- readRDS(file.path("results", "dge.filt4.rds"))
DEgenes <- readRDS("DEgenes1.rds")
```

# Differential expression

## Past Results

We add metadata to our list to get more information


## Lineae Reggression with limma-trend

Create the design matrix, using a reference model normal tissue. Then fit the linear regression model. Calculate moderated t-statistics and output results.

```{r}
mod <- model.matrix(~type, data = colData(thca.filt))
fit <- lmFit(assays(thca.filt)$logCPM, mod)
fit <- eBayes(fit)
dim(fit)
FDRcutoff <- 0.01
res <- decideTests(fit, p.value=FDRcutoff, lfc = abs(2.5))
summary(res)
```

A priori, with a FDR significance of 0.01, we have 95 down-regulated genes in tumor samples, whereas we have 40 up-regulated genes.

Output results in a better way, adding metadata

```{r}
genesmd <- data.frame(chr =as.character(seqnames(rowRanges(thca.filt))), symbol = rowData(thca.filt)[,1], stringsAsFactors = FALSE)
fit$genes <- genesmd
DEgenes1 <- topTable(fit, coef = 2, n = Inf, lfc = abs(2.5))
head(DEgenes2)
sort(table(DEgenes1$chr[DEgenes1$adj.P.Val < FDRcutoff]), decreasing = TRUE)
```

**Histogram**

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 2, 2))
hist(fit$p.value, xlab = "Raw P-values", main = "", las = 1)
```

**Volcano Plot**

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 3, 2))
volcanoplot(fit, coef = 2, highlight = 7, names = fit$genes$symbol, main = "Model 2",
las = 1)
```

**MA-plot**

```{r}
top7 <- order(fit$lods[, 2], decreasing = TRUE)[1:7]
limma::plotMA(fit, coef = 2, status = rownames(fit$lods) %in% DEgenes, legend = FALSE,
main = "Model 2", hl.pch = 46, hl.cex = 4, bg.pch = 46, bg.cex = 3, las = 1)
text(fit$Amean[top7], fit$coef[top7, 2], fit$genes$symbol[top7], cex = 0.5, pos = 4)
```

### Adjusting the model for unkwon covariates

```{r}
library(sva)
mod <- model.matrix(~type, colData(thca.filt))
mod0 <- model.matrix(~1, colData(thca.filt))
sv <- sva(assays(thca.filt)$logCPM, mod = mod, mod0 = mod0)
sv$n
mod <- cbind(mod, sv$sv)
colnames(mod) <- c(colnames(mod)[1:2], paste0("SV", 1:sv$n))
```

```{r}
fit2 <- lmFit(assays(thca.filt)$logCPM, mod)
fit2 <- eBayes(fit2)
res2 <- decideTests(fit2, p.value = FDRcutoff, lfc = abs(2.5))
summary(res2)
fit2$genes <- genesmd
DEgenes2 <- topTable(fit2, coef = 2, n = Inf, lfc = abs(2.5))
head(DEgenes2)
sort(table(DEgenes2$chr[DEgenes2$adj.P.Val < FDRcutoff]), decreasing = TRUE)
```

Now, we get 87 up-regulated genes in tumor samples, and 36 down-regulated.

**Histogram**

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 2, 2))
hist(fit2$p.value, xlab = "Raw P-values", main = "", las = 1)
```

**Volcano Plot**

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 3, 2))
volcanoplot(fit2, coef = 2, highlight = 7, names = fit2$genes$symbol, main = "Model 2",
las = 1)
```

**MA-plot**

```{r}
top7 <- order(fit2$lods[, 2], decreasing = TRUE)[1:7]
limma::plotMA(fit2, coef = 2, status = rownames(fit2$lods) %in% DEgenes, legend = FALSE,
main = "Model 2", hl.pch = 46, hl.cex = 4, bg.pch = 46, bg.cex = 3, las = 1)
text(fit2$Amean[top7], fit2$coef[top7, 2], fit2$genes$symbol[top7], cex = 0.5, pos = 4)
```

## Adjusting mean-variance with limma-voom

Calculate weights that estimate the mean-variance relationship at gene-by-sample level.

```{r}
v <- voom(dge.filt, mod, plot=TRUE)
```

We have a low correlationship between mean-variance

```{r}
fit3 <- lmFit(v, mod)
fit3 <- eBayes(fit3)
res3 <- decideTests(fit3, p.value=FDRcutoff, lfc = abs(2.5))
summary(res3)
fit3$genes <- genesmd
DEgenes3 <- topTable(fit3, coef=2, n=Inf, lfc = abs(2.5))
head(DEgenes3)
sort(table(DEgenes3$chr[DEgenes3$adj.P.Val < FDRcutoff]), decreasing = TRUE)
```

We get now 88 up-regulated genes in tumor, and 36 down-regulated.

**Histogtram**

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 2, 2))
hist(fit3$p.value, xlab = "Raw P-values", main = "", las = 1)
```

**Volcano Plot**

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 3, 2))
volcanoplot(fit3, coef = 2, highlight = 7, names = fit3$genes$symbol, main = "Model 3")
```

**MA-plot**

```{r}
top7 <- order(fit3$lods[, 2], decreasing = TRUE)[1:7]
limma::plotMA(fit3, coef = 2, status = rownames(fit3$lods) %in% DEgenes3, legend = FALSE, main = "Model 3", hl.pch = 46, hl.cex = 4, bg.pch = 46, bg.cex = 3, las = 1)
text(fit3$Amean[top7], fit3$coef[top7, 2], fit3$genes$symbol[top7], cex = 0.5, pos = 4)
```

## Adjusting for repeated measures

```{r}
sample_id <- substr(colnames(thca.filt), 9, 12)
colData(thca.filt)$sample_id <- factor(sample_id)
pair_table <- table(thca.filt$sample_id)
```

We observe that we have 44 individuals with tummor and normal samples. As we don't have enough paired samples to perform a Paired Subject Design, we are going to adjust for repeated measures.

```{r}
corfit <- duplicateCorrelation(assays(thca.filt)$logCPM, mod, block = thca.filt$sample_id)
corfit$consensus
```

We find that the correlation is large enough to be considered in the analysis

```{r}
fit4 <- lmFit(assays(thca.filt)$logCPM, mod, block = thca.filt$sample_id, correlation = corfit$consensus)
fit4 <- eBayes(fit4, trend = TRUE)
res4 <- decideTests(fit4, p.value = FDRcutoff, lfc = 2.5)
summary(res4)
fit4$genes <- genesmd
DEgenes4 <- topTable(fit4, coef = 2, n = Inf, lfc = 2.5)
head(DEgenes4)
sort(table(DEgenes4$chr[DEgenes4$adj.P.Val < FDRcutoff]), decreasing = TRUE)
```

We get 87 up-regulated genes in tumor and 37 down-regulated

**Histogtram**

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 2, 2))
hist(fit4$p.value, xlab = "Raw P-values", main = "", las = 1)
```

**Volcano Plot**

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 3, 2))
volcanoplot(fit4, coef = 2, highlight = 7, names = fit3$genes$symbol, main = "Model 4")
```

**MA-plot**

```{r}
top7 <- order(fit4$lods[, 2], decreasing = TRUE)[1:7]
limma::plotMA(fit4, coef = 2, status = rownames(fit4$lods) %in% DEgenes3, legend = FALSE, main = "Model 4", hl.pch = 46, hl.cex = 4, bg.pch = 46, bg.cex = 3, las = 1)
text(fit4$Amean[top7], fit4$coef[top7, 2], fit3$genes$symbol[top7], cex = 0.5, pos = 4)
```

## Paired Design

We need first to get only the data for those paired samples

```{r}
matrix <- as.matrix(pair_table)
mask <- matrix[,1] == 2
matrix <- matrix[mask, ]
mask2 <- thca.filt$sample_id %in% names(matrix)
thca.paired <- thca.filt[, mask2]
dge.paired <- dge.filt[, mask2]
saveRDS(thca.paired, "thca_paired_design.rds")
saveRDS(dge.paired, "dge_paired_design.rds")
```

Fitting the sva voom model to paired sample

```{r, message=FALSE, warning=FALSE}
mod <- model.matrix(~type, colData(thca.paired))
mod0 <- model.matrix(~1, colData(thca.paired))
sv <- sva(assays(thca.paired)$logCPM, mod = mod, mod0 = mod0)
sv$n
mod <- cbind(mod, sv$sv)
fit5 <- lmFit(assays(thca.paired)$logCPM, mod)
fit5 <- eBayes(fit5, trend=TRUE)
res5 <- decideTests(fit5, p.value = FDRcutoff, lfc=abs(2.5))
summary(res5)
fit5$genes <- genesmd
DEgenes5 <- topTable(fit5, coef=2, n=Inf, lfc=abs(2.5))
sort(table(DEgenes5$chr[DEgenes5$adj.P.Val < FDRcutoff]), decreasing = TRUE)
```

With this analysis, we get 99 up-regulated genes in tumor samples and 48 down-regulated.

**Histogram**

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 2, 2))
hist(fit5$p.value, xlab = "Raw P-values", main = "", las = 1)
```

**Volcano plot**

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 3, 2))
volcanoplot(fit5, coef = 2, highlight = 7, names = fit5$genes$symbol, main = "Model 5")
```

**MA-plot**

```{r}
top7 <- order(fit5$lods[, 2], decreasing = TRUE)[1:7]
limma::plotMA(fit5, coef = 2, status = rownames(fit5$lods) %in% DEgenes5, legend = FALSE, main = "Model 5", hl.pch = 46, hl.cex = 4, bg.pch = 46, bg.cex = 3, las = 1)
text(fit5$Amean[top7], fit5$coef[top7, 2], fit5$genes$symbol[top7], cex = 0.5, pos = 4)
```

Creo que este lo quitarÃ­a

## Session information

```{r, message=FALSE}
sessionInfo()
```