---
output:
  BiocStyle::html_document
---

<!---
Because we split the analysis pipeline in different independent files,
to speed up processing it, here in the setup block we load libraries and
objects that were loaded or produced in the previously processed file,
and which are necessary in this file.
--->

```{r setup, cache=FALSE, echo=FALSE, results='hide', message=FALSE}
library(knitr)
library(SummarizedExperiment)
library(edgeR)
library(geneplotter)

opts_chunk$set(cache=TRUE,
               cache.path="cache/file2",
               cache.extra=R.version.string,
               autodep=TRUE,
               fig.align="center",
               comment="")

thca <- readRDS("seTHCA.rds")
dge <- readRDS(file.path("./", "dge.rds"))
thca.filt.unnorm <- readRDS(file.path("./", "thca.filt.unnorm.rds"))
dge.filt.unnorm <- readRDS(file.path("./", "dge.filt.unnorm.rds"))
thca.filt <- readRDS(file.path("./", "thca.filt4.rds"))
dge.filt <- readRDS(file.path("./", "dge.filt4.rds"))
```

# Differential expression

As we have seen that samplevial can procude a confunding outcome, we are going to analyze this effect.
We perform a simple examination of expression changes and their associated p-values
using the R/Bioconductor package [sva](http://bioconductor.org/packages/sva).

We first observa how many differential expressed genes do we have without any batch adjustment


```{r}
library(sva)
mod <- model.matrix(~thca.filt$type, data = colData(thca.filt.batch))
mod0 <- model.matrix(~1, data = colData(thca.filt))
pv <- f.pvalue(assays(thca.filt)$logCPM, mod, mod0)
sum(p.adjust(pv, method="fdr") < 0.01)
```

There are `r sum(p.adjust(pv, method="fdr") < 0.01)` genes changing significantly
their expression at FDR < 1%. In Figure \@ref(fig:pdist) below we show the distribution of the
resulting p-values.

```{r pdist, echo=FALSE, out.width="400px", fig.cap="Distribution of raw p-values for an F-test on every gene between tumor and normal samples."}
```

Most of the genes have a p-value less than 0.1.

Now, let's estimate surrogate variables using the `sva()` function.

```{r}
sv <- sva(assays(thca.filt)$logCPM, mod, mod0)
sv$n
names(sv)
```

The SVA algorithm has found `r sv$n` surrogate variables. Let's use them to
assess againt the extent of differential expression this time adjusting for these surrogate variables.

```{r}
modsv <- cbind(mod, sv$sv)
mod0sv <- cbind(mod0, sv$sv)
pvsv <- f.pvalue(assays(thca.filt)$logCPM, modsv, mod0sv)
sum(p.adjust(pvsv, method="fdr") < 0.01)
```

We have increased the number of changing genes to `r sum(p.adjust(pvsv, method="fdr") < 0.01)`.
Figure \@ref(fig:psvdist) shows the resulting distribution of p-values.

```{r psvdist, echo=FALSE, out.width="400px", fig.cap="Distribution of raw p-values for an F-test on every gene between tumor and normal samples, adjusting for surrogate variables estimated with SVA."}
hist(pvsv, main="", las=1)
```

Once we have applied the batch adjustment, we want to check with a hierarchical clustering if there is not biases in our dataset.

```{r}
samplevial <- substr(colnames(thca.filt), 14, 16)
table(data.frame(TYPE=thca.filt$type, SV=samplevial))
logCPM <- cpm(dge.filt, log=TRUE, prior.count=3)
d <- as.dist(1-cor(logCPM, method="spearman"))
sampleClustering <- hclust(d)
batch <- as.integer(factor(samplevial))
sampleDendrogram <- as.dendrogram(sampleClustering, hang=0.1)
names(batch) <- colnames(thca.filt)
outcome <- paste(substr(colnames(thca.filt), 9, 12), as.character(thca.filt$type), sep="-")
names(outcome) <- colnames(thca.filt4)
sampleDendrogram <- dendrapply(sampleDendrogram,
                               function(x, batch, labels) {
                                 if (is.leaf(x)) {
                                   attr(x, "nodePar") <- list(lab.col=as.vector(batch[attr(x, "label")]))
                                   attr(x, "label") <- as.vector(labels[attr(x, "label")])
                                 }
                                 x
                               }, batch, outcome)
plot(sampleDendrogram, main="Hierarchical clustering of samples")
legend("topright", paste("Batch", sort(unique(batch)), levels(factor(samplevial))), fill=sort(unique(batch)))
```

##Removing Batch Effect: QRDecomposition

```{r}
library(limma)
qrexp <- removeBatchEffect(logCPM, batch, design = mod)
class(qrexp)
dim(qrexp)

d <- as.dist(1 - cor(qrexp, method = "spearman"))
sampleClustering <- hclust(d)
sampleDendrogram <- as.dendrogram(sampleClustering, hang = 0.1)
names(batch) <- colnames(thca.filt)
outcome <- as.character(thca.filt$type)
names(outcome) <- colnames(thca.filt)
sampleDendrogram <- dendrapply(sampleDendrogram, function(x, batch, labels) {
## for every node in the dendrogram if it is a leaf node
if (is.leaf(x)) {
attr(x, "nodePar") <- list(lab.col = as.vector(batch[attr(x, "label")])) ## color by batch
attr(x, "label") <- as.vector(labels[attr(x, "label")]) ## label by outcome
}
x
}, batch, outcome) ## these are the second and third arguments in the function
plot(sampleDendrogram, main = "Hierarchical clustering of samples")
legend("topright", paste("Batch", sort(unique(batch))), fill = sort(unique(batch)))
```

We can see that this method has no a good remove of the batch effect

##Removing Batch Effect: SVD
```{r, message=FALSE}
library(corpcor)
s <- fast.svd(t(scale(t(logCPM), center = TRUE, scale = TRUE)))
pcSds <- s$d
pcSds[1] <- 0
svdexp <- s$u %*% diag(pcSds) %*% t(s$v)
colnames(svdexp) <- colnames(thca.filt)
class(svdexp)
dim(svdexp)
d <- as.dist(1 - cor(svdexp, method = "spearman"))
sampleClustering <- hclust(d)
sampleDendrogram <- as.dendrogram(sampleClustering, hang = 0.1)
names(batch) <- colnames(thca.filt)
outcome <- as.character(thca.filt$type)
names(outcome) <- colnames(thca.filt)
sampleDendrogram <- dendrapply(sampleDendrogram, function(x, batch, labels) {
## for every node in the dendrogram if it is a leaf node
if (is.leaf(x)) {
attr(x, "nodePar") <- list(lab.col = as.vector(batch[attr(x, "label")])) ## color by batch
attr(x, "label") <- as.vector(labels[attr(x, "label")]) ## label by outcome
}
x
}, batch, outcome) ## these are the second and third arguments in the function
plot(sampleDendrogram, main = "Hierarchical clustering of samples")
legend("topright", paste("Batch", sort(unique(batch))), fill = sort(unique(batch)))
```


## Session information

```{r, message=FALSE}
sessionInfo()
```
