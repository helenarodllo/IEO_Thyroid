---
output:
  BiocStyle::html_document
---

<!---
Because we split the analysis pipeline in different independent files,
to speed up processing it, here in the setup block we load libraries and
objects that were loaded or produced in the previously processed file,
and which are necessary in this file.
--->

```{r setup, cache=FALSE, echo=FALSE, results='hide', message=FALSE}
library(knitr)
library(SummarizedExperiment)
library(edgeR)
library(geneplotter)

opts_chunk$set(cache=TRUE,
               cache.path="cache/file2",
               cache.extra=R.version.string,
               autodep=TRUE,
               fig.align="center",
               comment="")

thca <- readRDS("seTHCA.rds")
dge <- readRDS(file.path("./", "dge.rds"))
thca.filt.unnorm <- readRDS(file.path("./", "thca.filt.unnorm.rds"))
dge.filt.unnorm <- readRDS(file.path("./", "dge.filt.unnorm.rds"))
thca.filt <- readRDS(file.path("./", "thca.filt.rds"))
dge.filt <- readRDS(file.path("./", "dge.filt.rds"))
```

# Differential expression

As we have seen that samplevial can procude a confunding outcome, we are going to analyze this effect.
We perform a simple examination of expression changes and their associated p-values
using the R/Bioconductor package [sva](http://bioconductor.org/packages/sva).

#lo que esta mal es la adiccion del sample vial a la tabla 
```{r}
#names <- colnames(thca.filt)
#samplevial <- factor(substr(colnames(thca.filt), 14, 16), levels = substr(colnames(thca.filt), 14, 16), labels = colnames(thca.filt))
#factor(c(samplevial), levels = c("01A", "01B", "11C", "11B", "11A"))
#cbind(colData(thca.filt)$samplevial, samplevial)
maskb <- substr(colnames(thca.filt), 14, 16) != c("01B", "11C", "11B")
thca.filt.batch <- thca.filt[,maskb]
dge.filt.batch <- dge.filt[,maskb]
samplevial <- matrix(substr(colnames(thca.filt.batch), 14, 16), ncol = 1)
rownames(samplevial) <- colnames(thca.filt.batch)
sp <- factor(samplevial, labels <- rownames(samplevial))
thca.filt.batch$sp <- samplevial
batch <- as.integer(factor(samplevial))
mod <- model.matrix(~colData(thca.filt.batch)$type + samplevial, data = colData(thca.filt.batch))mod
logCPM <- cpm(dge.filt, log = TRUE, prior.count = 3)
```

##Adjusting Batch Effect: SVA

```{r}
library(sva)
mod0 <- model.matrix(~colData(thca.filt)$sp, data = colData(thca.filt))
head(mod0)
pv <- f.pvalue(assays(thca.filt)$logCPM, mod, mod0)
sum(p.adjust(pv, method="fdr") < 0.01)
```

##Removing Batch Effect: QRDecomposition

```{r}
library(limma)
qrexp <- removeBatchEffect(logCPM, batch, design = mod)
class(qrexp)
dim(qrexp)

d <- as.dist(1 - cor(qrexp, method = "spearman"))
sampleClustering <- hclust(d)
sampleDendrogram <- as.dendrogram(sampleClustering, hang = 0.1)
names(batch) <- colnames(thca.filt)
outcome <- as.character(thca.filt$type)
names(outcome) <- colnames(thca.filt)
sampleDendrogram <- dendrapply(sampleDendrogram, function(x, batch, labels) {
## for every node in the dendrogram if it is a leaf node
if (is.leaf(x)) {
attr(x, "nodePar") <- list(lab.col = as.vector(batch[attr(x, "label")])) ## color by batch
attr(x, "label") <- as.vector(labels[attr(x, "label")]) ## label by outcome
}
x
}, batch, outcome) ## these are the second and third arguments in the function
plot(sampleDendrogram, main = "Hierarchical clustering of samples")
legend("topright", paste("Batch", sort(unique(batch))), fill = sort(unique(batch)))
```

We can see that this method has no a good remove of the batch effect

##Removing Batch Effect: SVD
```{r, message=FALSE}
library(corpcor)
s <- fast.svd(t(scale(t(logCPM), center = TRUE, scale = TRUE)))
pcSds <- s$d
pcSds[1] <- 0
svdexp <- s$u %*% diag(pcSds) %*% t(s$v)
colnames(svdexp) <- colnames(thca.filt)
class(svdexp)
dim(svdexp)
d <- as.dist(1 - cor(svdexp, method = "spearman"))
sampleClustering <- hclust(d)
sampleDendrogram <- as.dendrogram(sampleClustering, hang = 0.1)
names(batch) <- colnames(thca.filt)
outcome <- as.character(thca.filt$type)
names(outcome) <- colnames(thca.filt)
sampleDendrogram <- dendrapply(sampleDendrogram, function(x, batch, labels) {
## for every node in the dendrogram if it is a leaf node
if (is.leaf(x)) {
attr(x, "nodePar") <- list(lab.col = as.vector(batch[attr(x, "label")])) ## color by batch
attr(x, "label") <- as.vector(labels[attr(x, "label")]) ## label by outcome
}
x
}, batch, outcome) ## these are the second and third arguments in the function
plot(sampleDendrogram, main = "Hierarchical clustering of samples")
legend("topright", paste("Batch", sort(unique(batch))), fill = sort(unique(batch)))
```

There are `r sum(p.adjust(pv, method="fdr") < 0.01)` genes changing significantly
their expression at FDR < 1%. In Figure \@ref(fig:pdist) below we show the distribution of the
resulting p-values.

```{r pdist, echo=FALSE, out.width="400px", fig.cap="Distribution of raw p-values for an F-test on every gene between tumor and normal samples."}
hist(pv, main="", las=1)
```

Now, let's estimate surrogate variables using the `sva()` function.

```{r}
sv <- sva(assays(thca.filt)$logCPM, mod, mod0)
sv$n
names(sv)
```

The SVA algorithm has found `r sv$n` surrogate variables. Let's use them to
assess againt the extent of differential expression this time adjusting for these
surrogate variables.

```{r}
modsv <- cbind(mod, sv$sv)
mod0sv <- cbind(mod0, sv$sv)
pvsv <- f.pvalue(assays(thca.filt)$logCPM, modsv, mod0sv)
sum(p.adjust(pvsv, method="fdr") < 0.01)
```

We have increased the number of changing genes to `r sum(p.adjust(pvsv, method="fdr") < 0.01)`.
Figure \@ref(fig:psvdist) shows the resulting distribution of p-values.

```{r psvdist, echo=FALSE, out.width="400px", fig.cap="Distribution of raw p-values for an F-test on every gene between tumor and normal samples, adjusting for surrogate variables estimated with SVA."}
hist(pvsv, main="", las=1)
```

## Session information

```{r, message=FALSE}
sessionInfo()
```
