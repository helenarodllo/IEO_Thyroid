---
output:
  bookdown::gitbook: default
  bookdown::pdf_book: default
---

```{r setup, cache=FALSE, echo=FALSE, results='hide', message=FALSE}
library(knitr)
library(SummarizedExperiment)
library(edgeR)
library(geneplotter)
library(sva)
library(corpcor)

opts_chunk$set(cache=TRUE,
               cache.path="cache/file2",
               cache.extra=R.version.string,
               autodep=TRUE,
               fig.align="center",
               comment="")

thca <- readRDS(file.path("raw_counts", "seTHCA.rds"))
dge <- readRDS(file.path("results", "dge.rds"))
thca.filt.unnorm <- readRDS(file.path("results", "thca.filt.unnorm.rds"))
dge.filt.unnorm <- readRDS(file.path("results", "dge.filt.unnorm.rds"))
thca.filt <- readRDS(file.path("results", "thca.filt4.rds"))
dge.filt <- readRDS(file.path("results", "dge.filt4.rds"))
```

# Differential expression

As it has seen in batch identification, there is a cluster of the dataset regarding to the samplevial, which can be confunding with the outcome of interest. Samplevial variable has 5 states with different and no-uniform sample sizes for each one, and we have a small dataset so we can not adjust the data for this batch. 

That way, a simple examination of expression changes and their associated p-values is going to be performed in order to try to capture sources of heterogeneity, such as non-biological variability, on the filtered and normalized dataset.

First of all, the number of significant differential expressed genes is calculated, this is done without any batch adjustment. The false discovery rate (FDR) approach is used to perform this calculation as some false positives can be accepted in this studie, the aim is to be more laxe.

```{r pvalue}
mod <- model.matrix(~thca.filt$type, data = colData(thca.filt))
mod0 <- model.matrix(~1, data = colData(thca.filt))
pv <- f.pvalue(assays(thca.filt)$logCPM, mod, mod0)
sum(p.adjust(pv, method="fdr") < 0.01)
```

There are `r sum(p.adjust(pv, method="fdr") < 0.01)` genes changing significantly
their expression at FDR < 1%. The distribution of the resulting p-values is shown in Figure \@ref(fig:pdist).

```{r pdist, echo=FALSE, fig.height=6, fig.width=12, fig.margin= TRUE, out.width="800px", fig.cap="Distribution of raw p-values for an F-test on every gene between tumor and normal samples."}
hist(pv, main="Histogram before batch adjustment", col = "skyblue", las=1, xlab="p-values", ylab = "Frequency")
```

This histogram shows that most of the genes have a p-value less than 0.1, so they are considered as significant diferential expressed genes.

The following step is to estimate surrogate variables by the surrogate variable analysis (SVA) method. 

```{r sva}
assays(thca.filt)$logCPM <- cpm(dge.filt, log=TRUE, prior.count=3)
sv <- sva(assays(thca.filt)$logCPM, mod, mod0)
sv$n
names(sv)
```

`r sv$n` surrogate variables are found, so the extent of differential expression is assessed adjusting for the.

```{r batchadjust}
modsv <- cbind(mod, sv$sv)
mod0sv <- cbind(mod0, sv$sv)
pvsv <- f.pvalue(assays(thca.filt)$logCPM, modsv, mod0sv)
sum(p.adjust(pvsv, method="fdr") < 0.01)
```

The number of differential expressed genes has increased to `r sum(p.adjust(pvsv, method="fdr") < 0.01)` with the batch adjustment.

Figure \@ref(fig:psvdist) shows the resulting distribution of adjusted p-values. More significant genes with FDR less than 1% can be observed.

```{r psvdist, echo=FALSE, fig.height=6, fig.width=12, fig.margin= TRUE, out.width="800px", fig.cap="Distribution of raw p-values for an F-test on every gene between tumor and normal samples, adjusting for surrogate variables estimated with SVA."}
hist(pvsv, main="Histogram after batch adjustment", col = "skyblue", las=1, xlab="p-values", ylab = "Frequency")
```

The distribution of adjusted p-values is very similar to raw ones, but we have more significant genes than before.

Once we have done a batch adjustement, we want to check (Figure \@ref(fig:sampleClusteringAdjust)) if our detected surrogate varible (samplevial) still has a confounding effect in our interested outcome variable.

```{r sampleClusteringAdjust, fig.height=6, fig.width=12, fig.margin= TRUE, fig.align='center', out.width="800px", echo=FALSE, fig.cap="Hierarchical clustering of the samples after adjusting for surrogate variables."}
samplevial <- substr(colnames(thca.filt), 14, 16)
logCPM <- cpm(dge.filt, log=TRUE, prior.count=3)
d <- as.dist(1-cor(logCPM, method="spearman"))
sampleClustering <- hclust(d)
batch <- as.integer(factor(samplevial))
sampleDendrogram <- as.dendrogram(sampleClustering, hang=0.1)
names(batch) <- colnames(thca.filt)
outcome <- as.character(thca.filt$type)
names(outcome) <- colnames(thca.filt)
sampleDendrogram <- dendrapply(sampleDendrogram,
                               function(x, batch, labels) {
                                 if (is.leaf(x)) {
                                   attr(x, "nodePar") <- list(lab.col=as.vector(batch[attr(x, "label")]))
                                   attr(x, "label") <- as.vector(labels[attr(x, "label")])
                                 }
                                 x
                               }, batch, outcome)
plot(sampleDendrogram, main="Hierarchical clustering of samples")
legend("topright", paste("Vial", sort(unique(batch)), levels(factor(samplevial))), fill=sort(unique(batch)))
```

It can be observed that there are still two clusters due to the surrogate variable, samplevial. The batch adjustement by SVA had no effect for this variable, so we are going to use an agressive strategy called *Singular Value Decomposition (SVD)* in order to remove this batch effect. Results would be again visualized with a Hierarchical Clustering (Figure \@ref(fig:sampleClusteringRemov)). 

```{r svd}
s <- fast.svd(t(scale(t(logCPM), center = TRUE, scale = TRUE)))
pcSds <- s$d
pcSds[1] <- 0
svdexp <- s$u %*% diag(pcSds) %*% t(s$v)
colnames(svdexp) <- colnames(thca.filt)
class(svdexp)
dim(svdexp)
```

```{r sampleClusteringRemov, fig.height=6, fig.width=12, fig.margin= TRUE, fig.align='center', out.width="800px", echo=FALSE, fig.cap="Hierarchical clustering after removing samplevial effect."}
d <- as.dist(1 - cor(svdexp, method = "spearman"))
sampleDendrogram <- dendrapply(sampleDendrogram, function(x, batch, labels) {
## for every node in the dendrogram if it is a leaf node
if (is.leaf(x)) {
attr(x, "nodePar") <- list(lab.col = as.vector(batch[attr(x, "label")])) ## color by sample vial
attr(x, "label") <- as.vector(labels[attr(x, "label")]) ## label by outcome
}
x
}, batch, outcome) ## these are the second and third arguments in the function
plot(sampleDendrogram, main = "Hierarchical clustering of samples")
legend("topright", paste("Vial", sort(unique(batch))), fill = sort(unique(batch)))
```

After SVD,removing the batch effect of sample vial is been achieved succesfully, in order to avoid counfunding results in the outcome of interest.

Now that we have normalized and adjust out data, we can obtain the truly differentially expressed genes between tumor and normal samples with significant logFC and p-value.

```{r genes}
tumExp <- rowMeans(logCPM[, thca.filt$type == "tumor"])
norExp <- rowMeans(logCPM[, thca.filt$type == "normal"])
log2fc <- norExp - tumExp
ranking <- order(abs(log2fc), decreasing = TRUE)
genes <- data.frame(LogFC = round(log2fc[ranking], digits = 3), PValue = round(pvsv, digits = 3), 
                    row.names = rowData(thca.filt)$symbol[ranking], check.names = FALSE)
genes$FDRcutoff <- (1:nrow(genes) * 0.05)/nrow(genes)
genes$FDRpval <- p.adjust(genes$PValue, method = "fdr")
head(genes)
```

From the 9423 genes that have passed all previous filters, 7519 genes have a significant p-value (< 0.01), but they are not all differentially expressed genes because several ones have a logFC close to 0 which means that there is not differnece between groups. 

In order to have a visual idea of the differential expressed genes, a *Volcano Plot* is performed in Figure \@ref(fig:VolcanoPlot), a widely used diagnostic
plot in DE analysis, in order to assess the extent of DE by plotting the raw p-values as function of their fold-changes, both in logarithmic scale.

```{r VolcanoPlot, fig.height=8, fig.width=12, out.width="800px", fig.margin= TRUE, fig.align='center', echo=FALSE, message=FALSE, fig.cap="Volcano Plot of normalized genes. Shows genes sorted by p-value in function of $\log_2$(fold change). Genes with a significant p-value are marked in orange, genes with a highl $\log_2$FC are marked in blue and genes with significant p-value and high $\log_2$FC are marked in gree."}
plot(genes$LogFC, -log10(genes$PValue), pch=".", cex=3, xlab="Log 2 fold-change", ylab="-Log 10 p-value", las=1, main="Volcano Plot")
# Add colored points: red if padj<0.05, orange of log2FC>1, green if both)
with(subset(genes, PValue < .05 ), points(LogFC, -log10(PValue),pch=20, col="chocolate1"))
with(subset(genes, abs(LogFC)>2.5), points(LogFC, -log10(PValue), pch=20, col="skyblue1"))
with(subset(genes, PValue<.05 & abs(LogFC)>2.5), points(LogFC, -log10(PValue), pch=20, col="darkolivegreen2"))
abline(h=-log10(max(genes$PValue[genes$FDRpval <= 0.05])), lty=2, col="red")
```

Most of the genes are located vertically to a value of $\log_2$FC close to 0, what means that they are not differential expressed between groups, altough they have a significant p-value (orange points). Points with a high $\log_2$FC are also observed, suggesting differential expression but with a non-significant p-value (blue points). Finally, green points are those genes with a high $\log_2$FC and significant p-value.

As we are only interested in genes painted in green, there is a need to filter the table by FDR < 0.01, to get only significant genes; and by $\log_2$FC > abs(2.5) in order to get the truly differentially expressed genes between tumor and normal samples. The table below shows the 111 DE genes wiht their correspoding values.

```{r DEgenes}
maskfdr <- genes$FDRpval < 0.01
maskfc <- genes$LogFC < -2.5 | genes$LogFC > 2.5
genes.DE <- genes[maskfdr & maskfc, ]
head(genes.DE)
```

A prior bibliographic search if the resulting genes was performed, those genes are verified to be mostly related with thyroid carcinome.

## Session information

```{r, message=FALSE}
sessionInfo()
```